(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8654],{2782:function(e,s,a){Promise.resolve().then(a.bind(a,7116))},7116:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return j}});var t=a(7437),n=a(2265),r=a(9376),l=a(1224),o=a(8349),i=a(5323),c=a(7029),d=a(8950),u=a.n(d);let v=e=>{var s,a,t,n,r,l,o,i,c,d,u,v,h,m,N,g,p,j,x,f,U,M;let w=null!==(o=null!==(l=null!==(r=null!==(n=null!==(t=e.otherUserId)&&void 0!==t?t:e.partnerId)&&void 0!==n?n:e.recipientId)&&void 0!==r?r:e.senderId)&&void 0!==l?l:e.conversationId)&&void 0!==o?o:"",b=e.otherUserName||e.recipientName||e.senderName||e.username||e.name||"Patreek User",A="".concat(null!==(i=e.senderId)&&void 0!==i?i:"0","-").concat(null!==(c=e.recipientId)&&void 0!==c?c:"0");return{id:(null!==(d=null===(a=e.id)||void 0===a?void 0:null===(s=a.toString)||void 0===s?void 0:s.call(a))&&void 0!==d?d:w)||A,otherUserId:null!==(u=null==w?void 0:w.toString())&&void 0!==u?u:"",otherUserName:b,otherUserAvatar:null!==(h=null!==(v=e.otherUserAvatarUrl)&&void 0!==v?v:e.avatarUrl)&&void 0!==h?h:e.profileImage,lastMessage:null!==(p=null!==(g=null!==(N=null!==(m=e.lastMessage)&&void 0!==m?m:e.lastMessageBody)&&void 0!==N?N:e.body)&&void 0!==g?g:e.subject)&&void 0!==p?p:"",lastMessageAt:null!==(x=null!==(j=e.lastMessageAt)&&void 0!==j?j:e.updatedAt)&&void 0!==x?x:e.createdAt,unreadCount:Number(null!==(M=null!==(U=null!==(f=e.unreadCount)&&void 0!==f?f:e.unread)&&void 0!==U?U:e.unreadMessages)&&void 0!==M?M:0)}},h=async e=>{var s,a,t;let n=await fetch(e,{method:"GET",headers:{Accept:"application/json"},credentials:"include"});if(!n.ok)throw Error("Unable to load conversations");let r=await n.json(),l=null!==(t=null!==(a=null!==(s=null==r?void 0:r.content)&&void 0!==s?s:null==r?void 0:r.data)&&void 0!==a?a:r)&&void 0!==t?t:[];return Array.isArray(l)?l.map(e=>v(e)):[]},m=e=>{if(!e)return"";let s=new Date(e).getTime();if(Number.isNaN(s))return e;let a=Math.floor((Date.now()-s)/6e4);if(a<1)return"now";if(a<60)return"".concat(a,"m ago");let t=Math.floor(a/60);return t<24?"".concat(t,"h ago"):"".concat(Math.floor(t/24),"d ago")},N=e=>{if(!e)return"PU";let s=e.trim().split(" ").filter(Boolean);return 0===s.length?"PU":s.slice(0,2).map(e=>e[0]).join("").toUpperCase()};function g(e){let{activeUserId:s,onSelectUser:a}=e,r="".concat(c.CT,"/api/v1/nest/conversations"),{data:l,error:o,isValidating:d}=(0,i.ZP)(r,h),v=(0,n.useMemo)(()=>l?[...l].sort((e,s)=>{let a=new Date(e.lastMessageAt||"").getTime();return(new Date(s.lastMessageAt||"").getTime()||0)-(a||0)}):[],[l]);return(0,n.useEffect)(()=>{!s&&v.length>0&&a(v[0],{openChat:!1})},[s,v,a]),(0,t.jsxs)("div",{className:u().sidebar,children:[(0,t.jsxs)("div",{className:u().sidebarHeader,children:[(0,t.jsx)("p",{className:u().sidebarTitle,children:"Conversations"}),(0,t.jsx)("p",{className:u().sidebarSubtitle,children:"Tap or click to continue a DM."})]}),o&&(0,t.jsx)("p",{className:u().errorMessage,children:"Unable to load conversations."}),d&&0===v.length?(0,t.jsx)("p",{className:u().placeholder,children:"Loading conversations…"}):0===v.length?(0,t.jsx)("p",{className:u().placeholder,children:"No conversations yet."}):(0,t.jsx)("div",{className:u().list,children:v.map(e=>{var n;let r=!!(e.otherUserId&&e.otherUserId===s),l=e.lastMessage&&e.lastMessage.length>70?"".concat(e.lastMessage.slice(0,70),"…"):e.lastMessage,o=m(e.lastMessageAt);return(0,t.jsxs)("button",{type:"button","aria-pressed":r,onClick:()=>a(e,{openChat:!0}),className:"".concat(u().conversationItem," ").concat(r?u().conversationActive:""),children:[(0,t.jsx)("div",{className:u().conversationAvatar,children:e.otherUserAvatar?(0,t.jsx)("img",{src:e.otherUserAvatar,alt:"".concat(null!==(n=e.otherUserName)&&void 0!==n?n:"User"," avatar")}):(0,t.jsx)("span",{children:N(e.otherUserName)})}),(0,t.jsxs)("div",{className:u().conversationContent,children:[(0,t.jsxs)("div",{className:u().conversationTopRow,children:[(0,t.jsx)("span",{className:u().conversationName,children:e.otherUserName||"Patreek User"}),o&&(0,t.jsx)("span",{className:u().conversationTime,children:o})]}),(0,t.jsx)("p",{className:u().conversationPreview,children:l||"No messages yet."}),(0,t.jsxs)("div",{className:u().conversationBottomRow,children:[(0,t.jsx)("span",{className:u().conversationTime,children:e.lastMessageAt?new Date(e.lastMessageAt).toLocaleDateString(void 0,{month:"short",day:"numeric"}):""}),e.unreadCount?(0,t.jsx)("span",{className:u().unreadBadge,children:e.unreadCount}):null]})]})]},e.id)})})]})}var p=a(3772);function j(){var e,s;let a=(0,r.useRouter)(),[i,d]=(0,n.useState)(!0),[v,h]=(0,n.useState)(!1),[m,N]=(0,n.useState)(null),[j,x]=(0,n.useState)(!1),[f,U]=(0,n.useState)(null),[M,w]=(0,n.useState)(!1),[b,A]=(0,n.useState)(!1);(0,n.useEffect)(()=>{let e=!0;return(async()=>{try{if(!(await (0,c.r$)()).authenticated){a.replace("/registration");return}if(!e)return;h(!0);let s=await (0,c.getUserProfile)();e&&N(s)}catch(e){console.error("[Nest] session check failed",e),a.replace("/registration")}finally{e&&d(!1)}})(),x("true"===localStorage.getItem("darkMode")),()=>{e=!1}},[a]),(0,n.useEffect)(()=>{let e=()=>{w(window.innerWidth<980)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),(0,n.useEffect)(()=>{M||A(!1)},[M]);let C=(0,n.useCallback)((e,s)=>{U(e);let a=(null==s?void 0:s.openChat)!==!1;M&&a&&A(!0)},[M]),I=(0,n.useCallback)(()=>{M&&A(!1)},[M]),S=(0,n.useMemo)(()=>{var e,s,a;return null!==(a=null==m?void 0:null===(s=m.id)||void 0===s?void 0:null===(e=s.toString)||void 0===e?void 0:e.call(s))&&void 0!==a?a:""},[m]);return i?(0,t.jsxs)("div",{className:"".concat(u().page," ").concat(j?u().dark:""),children:[(0,t.jsx)(l.Z,{hasSession:!0}),(0,t.jsxs)("main",{className:u().main,children:[(0,t.jsxs)("div",{className:u().intro,children:[(0,t.jsx)("h1",{className:u().introTitle,children:"Message Nest"}),(0,t.jsx)("p",{className:u().introSubtitle,children:"Loading conversations…"})]}),(0,t.jsx)("div",{className:u().chatPlaceholder,children:"Hang tight while we connect you to the nest."})]}),(0,t.jsx)(o.Z,{})]}):v?(0,t.jsxs)("div",{className:"".concat(u().page," ").concat(j?u().dark:""),children:[(0,t.jsx)(l.Z,{hasSession:!0}),(0,t.jsxs)("main",{className:u().main,children:[(0,t.jsxs)("div",{className:u().intro,children:[(0,t.jsx)("h1",{className:u().introTitle,children:"Message Nest"}),(0,t.jsx)("p",{className:u().introSubtitle,children:"A Twitter DM inspired experience for your stack."})]}),(0,t.jsxs)("section",{className:u().layout,children:[(0,t.jsx)("div",{className:"".concat(u().sidebar," ").concat(M&&b?u().mobileHidden:""),children:(0,t.jsx)(g,{activeUserId:null==f?void 0:f.otherUserId,onSelectUser:C})}),(0,t.jsx)("div",{className:"".concat(u().chatColumn," ").concat(M&&!b?u().mobileHidden:""),children:(0,t.jsx)(p.Z,{otherUserId:null==f?void 0:f.otherUserId,otherUserName:null==f?void 0:f.otherUserName,otherUserAvatar:null==f?void 0:f.otherUserAvatar,currentUserId:S,currentUsername:null!==(s=null!==(e=null==m?void 0:m.username)&&void 0!==e?e:null==m?void 0:m.name)&&void 0!==s?s:null,onClose:M?I:void 0})})]})]}),(0,t.jsx)(o.Z,{})]}):null}}},function(e){e.O(0,[4937,6313,2972,9752,6547,7029,8659,2971,2117,1744],function(){return e(e.s=2782)}),_N_E=e.O()}]);