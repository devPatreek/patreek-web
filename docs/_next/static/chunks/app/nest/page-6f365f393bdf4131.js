(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8654],{2782:function(e,a,t){Promise.resolve().then(t.bind(t,3495))},3495:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return j}});var s=t(7437),n=t(2265),r=t(9376),i=t(1224),l=t(8349),o=t(5323),c=t(8950),d=t.n(c);let u=e=>{var a,t,s,n,r,i,l,o,c,d,u,h,m,v,_,N,p,b,g,f,j,x;let k=null!==(l=null!==(i=null!==(r=null!==(n=null!==(s=e.otherUserId)&&void 0!==s?s:e.partnerId)&&void 0!==n?n:e.recipientId)&&void 0!==r?r:e.senderId)&&void 0!==i?i:e.conversationId)&&void 0!==l?l:"",M=e.otherUserName||e.recipientName||e.senderName||e.username||e.name||"Patreek User",w="".concat(null!==(o=e.senderId)&&void 0!==o?o:"0","-").concat(null!==(c=e.recipientId)&&void 0!==c?c:"0");return{id:(null!==(d=null===(t=e.id)||void 0===t?void 0:null===(a=t.toString)||void 0===a?void 0:a.call(t))&&void 0!==d?d:k)||w,otherUserId:null!==(u=null==k?void 0:k.toString())&&void 0!==u?u:"",otherUserName:M,otherUserAvatar:null!==(m=null!==(h=e.otherUserAvatarUrl)&&void 0!==h?h:e.avatarUrl)&&void 0!==m?m:e.profileImage,lastMessage:null!==(p=null!==(N=null!==(_=null!==(v=e.lastMessage)&&void 0!==v?v:e.lastMessageBody)&&void 0!==_?_:e.body)&&void 0!==N?N:e.subject)&&void 0!==p?p:"",lastMessageAt:null!==(g=null!==(b=e.lastMessageAt)&&void 0!==b?b:e.updatedAt)&&void 0!==g?g:e.createdAt,unreadCount:Number(null!==(x=null!==(j=null!==(f=e.unreadCount)&&void 0!==f?f:e.unread)&&void 0!==j?j:e.unreadMessages)&&void 0!==x?x:0)}},h=async e=>{var a,t,s;let n=await fetch(e,{method:"GET",headers:{Accept:"application/json"},credentials:"include"});if(!n.ok)throw Error("Unable to load conversations");let r=await n.json(),i=null!==(s=null!==(t=null!==(a=null==r?void 0:r.content)&&void 0!==a?a:null==r?void 0:r.data)&&void 0!==t?t:r)&&void 0!==s?s:[];return Array.isArray(i)?i.map(e=>u(e)):[]},m=e=>{if(!e)return"";let a=new Date(e).getTime();if(Number.isNaN(a))return e;let t=Math.floor((Date.now()-a)/6e4);if(t<1)return"now";if(t<60)return"".concat(t,"m ago");let s=Math.floor(t/60);return s<24?"".concat(s,"h ago"):"".concat(Math.floor(s/24),"d ago")},v=e=>{if(!e)return"PU";let a=e.trim().split(" ").filter(Boolean);return 0===a.length?"PU":a.slice(0,2).map(e=>e[0]).join("").toUpperCase()};function _(e){let{activeUserId:a,onSelectUser:t}=e,{data:r,error:i,isValidating:l}=(0,o.ZP)("/api/v1/nest/conversations",h),c=(0,n.useMemo)(()=>r?[...r].sort((e,a)=>{let t=new Date(e.lastMessageAt||"").getTime();return(new Date(a.lastMessageAt||"").getTime()||0)-(t||0)}):[],[r]);return(0,n.useEffect)(()=>{!a&&c.length>0&&t(c[0],{openChat:!1})},[a,c,t]),(0,s.jsxs)("div",{className:d().sidebar,children:[(0,s.jsxs)("div",{className:d().sidebarHeader,children:[(0,s.jsx)("p",{className:d().sidebarTitle,children:"Conversations"}),(0,s.jsx)("p",{className:d().sidebarSubtitle,children:"Tap or click to continue a DM."})]}),i&&(0,s.jsx)("p",{className:d().errorMessage,children:"Unable to load conversations."}),l&&0===c.length?(0,s.jsx)("p",{className:d().placeholder,children:"Loading conversations…"}):0===c.length?(0,s.jsx)("p",{className:d().placeholder,children:"No conversations yet."}):(0,s.jsx)("div",{className:d().list,children:c.map(e=>{var n;let r=!!(e.otherUserId&&e.otherUserId===a),i=e.lastMessage&&e.lastMessage.length>70?"".concat(e.lastMessage.slice(0,70),"…"):e.lastMessage,l=m(e.lastMessageAt);return(0,s.jsxs)("button",{type:"button","aria-pressed":r,onClick:()=>t(e,{openChat:!0}),className:"".concat(d().conversationItem," ").concat(r?d().conversationActive:""),children:[(0,s.jsx)("div",{className:d().conversationAvatar,children:e.otherUserAvatar?(0,s.jsx)("img",{src:e.otherUserAvatar,alt:"".concat(null!==(n=e.otherUserName)&&void 0!==n?n:"User"," avatar")}):(0,s.jsx)("span",{children:v(e.otherUserName)})}),(0,s.jsxs)("div",{className:d().conversationContent,children:[(0,s.jsxs)("div",{className:d().conversationTopRow,children:[(0,s.jsx)("span",{className:d().conversationName,children:e.otherUserName||"Patreek User"}),l&&(0,s.jsx)("span",{className:d().conversationTime,children:l})]}),(0,s.jsx)("p",{className:d().conversationPreview,children:i||"No messages yet."}),(0,s.jsxs)("div",{className:d().conversationBottomRow,children:[(0,s.jsx)("span",{className:d().conversationTime,children:e.lastMessageAt?new Date(e.lastMessageAt).toLocaleDateString(void 0,{month:"short",day:"numeric"}):""}),e.unreadCount?(0,s.jsx)("span",{className:d().unreadBadge,children:e.unreadCount}):null]})]})]},e.id)})})]})}let N=e=>{var a,t,s,n,r,i,l,o,c,d,u,h,m,v,_,N,p;let b=null!==(c=null===(a=(t=null!==(o=null!==(l=null!==(i=null!==(r=e.senderId)&&void 0!==r?r:e.userId)&&void 0!==i?i:e.senderUserId)&&void 0!==l?l:e.senderUsername)&&void 0!==o?o:"unknown").toString)||void 0===a?void 0:a.call(t))&&void 0!==c?c:"unknown",g=null!==(u=null!==(d=e.createdAt)&&void 0!==d?d:e.timestamp)&&void 0!==u?u:new Date().toISOString(),f=null!==(v=null!==(m=null!==(h=e.body)&&void 0!==h?h:e.text)&&void 0!==m?m:e.message)&&void 0!==v?v:"";return{id:null!==(_=null===(n=e.id)||void 0===n?void 0:null===(s=n.toString)||void 0===s?void 0:s.call(n))&&void 0!==_?_:"".concat(b,"-").concat(g),senderId:b,senderName:null!==(p=null!==(N=e.senderName)&&void 0!==N?N:e.displayName)&&void 0!==p?p:e.senderUsername,body:f,createdAt:g}},p=async e=>{var a,t,s;let n=await fetch(e,{method:"GET",headers:{Accept:"application/json"},credentials:"include"});if(!n.ok)throw Error("Unable to load chat history");let r=await n.json(),i=null!==(s=null!==(t=null!==(a=null==r?void 0:r.content)&&void 0!==a?a:null==r?void 0:r.data)&&void 0!==t?t:r)&&void 0!==s?s:[];return Array.isArray(i)?i.map(e=>N(e)):[]},b=e=>{if(!e)return"";let a=new Date(e);return Number.isNaN(a.getTime())?e:a.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit"})};function g(e){let{otherUserId:a,otherUserName:t,otherUserAvatar:r,currentUserId:i,onClose:l}=e,c=null==i?void 0:i.toString(),u=a?"/api/v1/nest/messages/".concat(encodeURIComponent(a)):null,{data:h,error:m,isValidating:v,mutate:_}=(0,o.ZP)(u,u?p:null,{refreshInterval:3e3,revalidateOnFocus:!1}),N=(0,n.useMemo)(()=>h?[...h].sort((e,a)=>new Date(e.createdAt).getTime()-new Date(a.createdAt).getTime()):[],[h]),[g,f]=(0,n.useState)(""),[j,x]=(0,n.useState)(!1),[k,M]=(0,n.useState)(""),w=(0,n.useRef)(null);(0,n.useEffect)(()=>{w.current&&(w.current.scrollTop=w.current.scrollHeight)},[N.length]);let y=async e=>{if(e&&e.preventDefault(),!u||!g.trim()||j)return;x(!0);let t=g.trim(),s={id:"temp-".concat(Date.now(),"-").concat(Math.random()),senderId:null!=c?c:"me",senderName:"You",body:t,createdAt:new Date().toISOString(),pending:!0};_(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return[...e,s]},!1),f(""),M("");try{if(!(await fetch("/api/v1/nest/message",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({recipientId:a,body:t})})).ok)throw Error("Failed to send message");await _()}catch(e){_(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.filter(e=>e.id!==s.id)},!1),M("Unable to send message. Please try again."),console.error(e)}finally{x(!1)}},S=!!u;return(0,s.jsxs)("div",{className:d().chatArea,children:[(0,s.jsxs)("div",{className:d().chatHeader,children:[l&&(0,s.jsx)("button",{type:"button",className:d().mobileBack,onClick:l,"aria-label":"Back to conversations",children:"←"}),(0,s.jsxs)("div",{className:d().chatHeaderInfo,children:[(0,s.jsx)("span",{className:d().chatUserName,children:t||"Choose a conversation"}),(0,s.jsx)("span",{className:d().chatSubtitle,children:r?"Live chat":"Message nest user"})]})]}),S?m?(0,s.jsx)("div",{className:d().chatPlaceholder,children:"Unable to load chat history."}):(0,s.jsxs)("div",{ref:w,className:d().chatMessages,children:[N.map(e=>{let a=!!(c&&e.senderId===c);return(0,s.jsxs)("div",{className:d().chatMessageRow,children:[(0,s.jsx)("div",{className:"".concat(d().chatBubble," ").concat(a?d().chatBubbleMine:""," ").concat(e.pending?d().chatBubblePending:""),children:e.body}),(0,s.jsxs)("span",{className:"".concat(d().chatTimestamp," ").concat(a?d().chatTimestampMine:""),children:[b(e.createdAt)," ",e.pending?"• Sending…":""]})]},e.id)}),v&&!N.length&&(0,s.jsx)("p",{className:d().placeholder,children:"Loading messages…"})]}):(0,s.jsx)("div",{className:d().chatPlaceholder,children:"Select a conversation to open the chat."}),S&&(0,s.jsxs)("div",{className:d().chatFooter,children:[k&&(0,s.jsx)("p",{className:d().errorMessage,children:k}),(0,s.jsxs)("form",{className:d().chatForm,onSubmit:y,children:[(0,s.jsx)("textarea",{className:d().chatInput,placeholder:"Write a message…",value:g,onChange:e=>f(e.target.value),rows:2}),(0,s.jsx)("button",{type:"submit",className:"".concat(d().sendButton," ").concat(g.trim()&&!j?d().sendButtonActive:""),disabled:j||!g.trim(),children:j?"Sending…":"Send"})]})]})]})}var f=t(7029);function j(){let e=(0,r.useRouter)(),[a,t]=(0,n.useState)(!0),[o,c]=(0,n.useState)(!1),[u,h]=(0,n.useState)(null),[m,v]=(0,n.useState)(!1),[N,p]=(0,n.useState)(null),[b,j]=(0,n.useState)(!1),[x,k]=(0,n.useState)(!1);(0,n.useEffect)(()=>{let a=!0;return(async()=>{try{if(!(await (0,f.r$)()).authenticated){e.replace("/registration");return}if(!a)return;c(!0);let t=await (0,f.getUserProfile)();a&&h(t)}catch(a){console.error("[Nest] session check failed",a),e.replace("/registration")}finally{a&&t(!1)}})(),v("true"===localStorage.getItem("darkMode")),()=>{a=!1}},[e]),(0,n.useEffect)(()=>{let e=()=>{j(window.innerWidth<980)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),(0,n.useEffect)(()=>{b||k(!1)},[b]);let M=(0,n.useCallback)((e,a)=>{p(e);let t=(null==a?void 0:a.openChat)!==!1;b&&t&&k(!0)},[b]),w=(0,n.useCallback)(()=>{b&&k(!1)},[b]),y=(0,n.useMemo)(()=>{var e,a,t;return null!==(t=null==u?void 0:null===(a=u.id)||void 0===a?void 0:null===(e=a.toString)||void 0===e?void 0:e.call(a))&&void 0!==t?t:""},[u]);return a?(0,s.jsxs)("div",{className:"".concat(d().page," ").concat(m?d().dark:""),children:[(0,s.jsx)(i.Z,{hasSession:!0}),(0,s.jsxs)("main",{className:d().main,children:[(0,s.jsxs)("div",{className:d().intro,children:[(0,s.jsx)("h1",{className:d().introTitle,children:"Message Nest"}),(0,s.jsx)("p",{className:d().introSubtitle,children:"Loading conversations…"})]}),(0,s.jsx)("div",{className:d().chatPlaceholder,children:"Hang tight while we connect you to the nest."})]}),(0,s.jsx)(l.Z,{})]}):o?(0,s.jsxs)("div",{className:"".concat(d().page," ").concat(m?d().dark:""),children:[(0,s.jsx)(i.Z,{hasSession:!0}),(0,s.jsxs)("main",{className:d().main,children:[(0,s.jsxs)("div",{className:d().intro,children:[(0,s.jsx)("h1",{className:d().introTitle,children:"Message Nest"}),(0,s.jsx)("p",{className:d().introSubtitle,children:"A Twitter DM inspired experience for your stack."})]}),(0,s.jsxs)("section",{className:d().layout,children:[(0,s.jsx)("div",{className:"".concat(d().sidebar," ").concat(b&&x?d().mobileHidden:""),children:(0,s.jsx)(_,{activeUserId:null==N?void 0:N.otherUserId,onSelectUser:M})}),(0,s.jsx)("div",{className:"".concat(d().chatColumn," ").concat(b&&!x?d().mobileHidden:""),children:(0,s.jsx)(g,{otherUserId:null==N?void 0:N.otherUserId,otherUserName:null==N?void 0:N.otherUserName,otherUserAvatar:null==N?void 0:N.otherUserAvatar,currentUserId:y,onClose:b?w:void 0})})]})]}),(0,s.jsx)(l.Z,{})]}):null}},8349:function(e,a,t){"use strict";t.d(a,{Z:function(){return c}});var s=t(7437),n=t(7648),r=t(1468),i=t.n(r);let l=[{label:"Privacy",href:"/privacy"},{label:"Terms",href:"/terms"},{label:"Help",href:"/help"},{label:"About",href:"/about"}],o=[{label:"X",href:"https://x.com/patreek",aria:"Open Patreek on X"},{label:"Facebook",href:"https://facebook.com",aria:"Open Patreek on Facebook"},{label:"Instagram",href:"https://instagram.com",aria:"Open Patreek on Instagram"}];function c(){let e=new Date().getFullYear();return(0,s.jsxs)("footer",{className:i().footer,children:[(0,s.jsx)("div",{className:i().links,children:l.map(e=>(0,s.jsx)(n.default,{href:e.href,className:i().link,children:e.label},e.label))}),(0,s.jsxs)("div",{className:i().right,children:[(0,s.jsxs)("span",{className:i().copy,children:["\xa9 ",e," Patreek"]}),(0,s.jsx)("div",{className:i().socials,children:o.map(e=>(0,s.jsx)("a",{href:e.href,target:"_blank",rel:"noopener noreferrer","aria-label":e.aria,className:i().socialButton,children:"X"===e.label?"X":e.label.charAt(0)},e.label))})]})]})}},1224:function(e,a,t){"use strict";t.d(a,{Z:function(){return d}});var s=t(7437),n=t(2265),r=t(7648),i=t(9376),l=t(6914),o=t.n(l),c=t(7029);function d(e){let{hasSession:a=!1,active:t}=e,l=(0,i.useRouter)(),d=(0,i.usePathname)(),[u,h]=(0,n.useState)(null),[m,v]=(0,n.useState)(!1),_=(0,n.useMemo)(()=>null==t?void 0:t.toLowerCase(),[t]),N=[{label:"Coins",path:"/coins"},{label:"Community",path:"/community"},{label:"Shop",path:"https://shop.patreek.com"},{label:"Opinion",path:"/opinion"},{label:"Write",path:"/write"}];(0,n.useEffect)(()=>{(async()=>{if(a)try{if(!(await (0,c.r$)()).authenticated)return;let e=await (0,c.getUserProfile)();(null==e?void 0:e.username)&&h(e.username)}catch(e){h(null)}})()},[a]);let p=e=>!!(_&&_===e.label.toLowerCase()||d&&e.path.startsWith("/")&&d.startsWith(e.path));return(0,s.jsxs)("header",{className:o().header,children:[(0,s.jsx)("div",{className:o().brand,onClick:()=>l.push("/"),children:"Patreek"}),(0,s.jsx)("nav",{className:o().nav,children:N.map(e=>(0,s.jsx)(r.default,{href:e.path,className:"".concat(o().navLink," ").concat(p(e)?o().activeLink:""),target:e.path.startsWith("http")?"_blank":void 0,children:e.label},e.label))}),(0,s.jsxs)("div",{className:o().actions,children:[(0,s.jsx)("button",{type:"button",className:o().iconButton,"aria-label":"Search Patreek",children:"\uD83D\uDD0D"}),(0,s.jsx)("button",{type:"button",className:o().profileCircle,onClick:()=>{a&&u?l.push("/u/".concat(u)):l.push("/registration")},"aria-label":"Open profile",children:u?u[0].toUpperCase():"P"}),(0,s.jsxs)("button",{type:"button",className:o().hamburger,onClick:()=>v(e=>!e),"aria-label":"Toggle navigation",children:[(0,s.jsx)("span",{}),(0,s.jsx)("span",{}),(0,s.jsx)("span",{})]})]}),m&&(0,s.jsx)("div",{className:o().mobileNav,children:N.map(e=>(0,s.jsx)(r.default,{href:e.path,className:o().mobileNavItem,onClick:()=>v(!1),children:e.label},e.label))})]})}},1468:function(e){e.exports={footer:"Footer_footer__pQtti",links:"Footer_links__cFiYr",link:"Footer_link__TBOP7",right:"Footer_right__s6ko6",copy:"Footer_copy__KUC9W",socials:"Footer_socials__Arjjf",socialButton:"Footer_socialButton__owWdN"}},6914:function(e){e.exports={header:"MainHeader_header__v29oY",brand:"MainHeader_brand__PWSjn",nav:"MainHeader_nav__OWvbh",navLink:"MainHeader_navLink__NUd27",activeLink:"MainHeader_activeLink__YR7BN",actions:"MainHeader_actions__jUZ_j",iconButton:"MainHeader_iconButton__6RFhG",profileCircle:"MainHeader_profileCircle__654Xs",hamburger:"MainHeader_hamburger__9fVCh",mobileNav:"MainHeader_mobileNav__RVDMJ",mobileNavItem:"MainHeader_mobileNavItem__n0yAB"}},8950:function(e){e.exports={page:"Nest_page___yV6N",dark:"Nest_dark__CKKHW",main:"Nest_main__J5eEH",intro:"Nest_intro__smxCu",introTitle:"Nest_introTitle__Gcqx5",introSubtitle:"Nest_introSubtitle__pDsIe",layout:"Nest_layout__DxSWs",sidebar:"Nest_sidebar__MihBh",chatColumn:"Nest_chatColumn__8fTs3",chatArea:"Nest_chatArea__lUl5r",sidebarHeader:"Nest_sidebarHeader__C_5oE",sidebarTitle:"Nest_sidebarTitle__dbiti",sidebarSubtitle:"Nest_sidebarSubtitle__pjPWz",list:"Nest_list__FtO4A",conversationItem:"Nest_conversationItem__Rsx2F",conversationActive:"Nest_conversationActive__na1JN",conversationAvatar:"Nest_conversationAvatar__dWIWq",conversationContent:"Nest_conversationContent__7b0Nx",conversationTopRow:"Nest_conversationTopRow__KZuJm",conversationName:"Nest_conversationName__6LYt0",conversationTime:"Nest_conversationTime__vVk9x",conversationPreview:"Nest_conversationPreview__CpWPW",conversationBottomRow:"Nest_conversationBottomRow__TLyYi",unreadBadge:"Nest_unreadBadge__uIbje",chatHeader:"Nest_chatHeader__9T9om",chatHeaderInfo:"Nest_chatHeaderInfo__UrdYS",chatUserName:"Nest_chatUserName__5DTks",chatSubtitle:"Nest_chatSubtitle__Fu7_Y",mobileBack:"Nest_mobileBack__5afX4",chatMessages:"Nest_chatMessages__yigPb",chatMessageRow:"Nest_chatMessageRow__B_TMz",chatBubble:"Nest_chatBubble__kbvJa",chatBubbleMine:"Nest_chatBubbleMine__MbqWZ",chatBubblePending:"Nest_chatBubblePending__aqd_F",chatTimestamp:"Nest_chatTimestamp__5vTds",chatTimestampMine:"Nest_chatTimestampMine__e6RKz",chatFooter:"Nest_chatFooter__i3sQh",chatForm:"Nest_chatForm__5zIqr",chatInput:"Nest_chatInput__ad88Q",sendButton:"Nest_sendButton__sff9g",sendButtonActive:"Nest_sendButtonActive__mtVix",chatPlaceholder:"Nest_chatPlaceholder__4hqtE",errorMessage:"Nest_errorMessage__SpWq1",placeholder:"Nest_placeholder__Ks3Eb",mobileHidden:"Nest_mobileHidden__r_6cE"}}},function(e){e.O(0,[7123,4977,2972,3767,7029,2971,2117,1744],function(){return e(e.s=2782)}),_N_E=e.O()}]);